<apex:page standardController="Lead" extensions="latticeforleads.LatticeLeadDetailsExtensionController">
    <iframe id="latticeIframe" height="850px" width="100%" frameborder="0"/>
    <c:LatticeCommonUtils />
    <apex:includeScript value="{!$Resource.latticeforleads__Jquery191}"/>
    <script src="/soap/ajax/24.0/connection.js" type="text/javascript"></script>
    <script language="javascript" runat="server">
    $(document).ready(function() {
        var leadId = "{!lead.id}";
        var baseLatticeUrl = "{!latticeUrl}";
        var latticeUrl = baseLatticeUrl + "?sin={!$Api.Session_ID}";
        latticeUrl += "&serverurl={!$Api.Partner_Server_URL_90}";
        latticeUrl += "&Directory=salesforce&userlink={!$User.Id}";
        latticeUrl += "&Lead=" + leadId;
        latticeUrl += "&HasSalesprism={!isSalesprismInstalled}";
        latticeUrl += "&CustomSettings=" + encodeURIComponent('{!customSettings}');
        
        var accountId = null;
        sforce.connection.sessionId = "{!$Api.Session_ID}";
        try {
            var query = sforce.connection.query("SELECT id,latticeforleads__AccountID__c FROM Lead where id='"+ leadId +"'");
            var records = query.getArray("records");
            if (query.size == 1 && records != null) {
                accountId = LatticeCommon.convertSalesforceId(records[0].latticeforleads__AccountID__c);
            }
        } catch (err) {}
        
        if (accountId != null) {
            latticeUrl += "&Account=" + accountId;
        }
        
        // Listen for when our Dante sends postMessage events
        window.addEventListener('message', function (evt) {
            if (evt && evt.data.indexOf("IsLeadActiveEvent") !== -1) {
                var separatorIndex = evt.data.indexOf("=");
                var leadId = evt.data.substring(separatorIndex + 1, evt.data.length);
                var message = "IsLeadActiveReturnEvent=" + leadId + "?isActive=" + true;
                evt.source.postMessage(message , evt.origin);
            } else if (evt && evt.data.indexOf("GoToSalesprismAccountEvent") !== -1) {
                var separatorIndex = evt.data.indexOf("=");
                var accountId = evt.data.substring(separatorIndex + 1, evt.data.length);
                            
                var salesforceHost = window.location.host;
                var latticeForLeadsPrefix = salesforceHost.indexOf("latticeforleads.");
                if (latticeForLeadsPrefix !== -1) {
                    salesforceHost = salesforceHost.substring(16, salesforceHost.length);
                }
                
                var accountDfd = LatticeCommon.getAccountLinkField(accountId, "{!accountLinkField}");
                $.when(accountDfd).then(function (result) {
                    var accountField = result;
                    var salesprismUrl = window.location.protocol + "//salesprism." + salesforceHost +
                        "/apex/salesPRISM?sfdc.tabName=salesPRISM&Account=" + accountField;
                    window.open(salesprismUrl, "_blank");
                });
            }
            
        }, false);
        
        $("#latticeIframe").attr('src', latticeUrl);
    });
    </script>
</apex:page>