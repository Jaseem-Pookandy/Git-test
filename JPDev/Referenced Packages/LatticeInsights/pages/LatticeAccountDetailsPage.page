<apex:page standardController="Contact" extensions="latticeforleads.LatticeAccountDetailsExtensionController">
    <iframe id="latticeIframe" height="850px" width="100%" frameborder="0"/>
    <c:LatticeCommonUtils />
    <apex:includeScript value="{!$Resource.latticeforleads__Jquery191}"/>
    <script language="javascript" runat="server">
    $(document).ready(function() {
        var baseLatticeUrl = "{!latticeUrl}";
        var latticeUrl = baseLatticeUrl + "?sin={!$Api.Session_ID}";
        latticeUrl += "&serverurl={!$Api.Partner_Server_URL_90}";
        latticeUrl += "&Directory=salesforce&userlink={!$User.Id}";
        latticeUrl += "&Account={!contact.AccountId}";
        latticeUrl += "&HasSalesprism={!isSalesprismInstalled}";
        latticeUrl += "&CustomSettings=" + encodeURIComponent('{!customSettings}');
        
        $("#latticeIframe").attr('src', latticeUrl);
        
        // Listen for when our Dante sends postMessage events
        window.addEventListener('message', function (evt) {
            if (evt && evt.data.indexOf("IsLeadActiveEvent") !== -1) {
                var separatorIndex = evt.data.indexOf("=");
                var leadId = evt.data.substring(separatorIndex + 1, evt.data.length);
                var leadDfd = LatticeCommon.getRemoteItem(
                    '{!$RemoteAction.LatticeAccountDetailsExtensionController.getLeadById}', 
                    leadId
                );
                $.when(leadDfd).then(function (result) {
                    var lead = result;
                    var isActive = !lead.IsDeleted && !lead.IsConverted; 
                    var message = "IsLeadActiveReturnEvent=" + lead.Id + "?isActive=" + isActive;
                    evt.source.postMessage(message , evt.origin);
                });
            } else if (evt && evt.data.indexOf("GoToSalesprismAccountEvent") !== -1) {
                var accountId = "{!contact.AccountId}";
                var salesforceHost = window.location.host;
                var latticeForLeadsPrefix = salesforceHost.indexOf("lattice.");
                if (latticeForLeadsPrefix !== -1) {
                    salesforceHost = salesforceHost.substring(8, salesforceHost.length);
                }
                
                var accountDfd = LatticeCommon.getAccountLinkField(accountId, "{!accountLinkField}");
                $.when(accountDfd).then(function (result) {
                    var accountField = result;
                    var salesprismUrl = window.location.protocol + "//salesprism." + salesforceHost +
                        "/apex/salesPRISM?sfdc.tabName=salesPRISM&Account=" + accountField;
                    window.open(salesprismUrl, "_blank");
                });
            }
            
        }, false);
    });
    </script>
</apex:page>