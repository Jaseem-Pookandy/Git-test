<apex:page standardController="Opportunity" extensions="latticeforleads.LatticeLeadDetailsExtensionController">
    <iframe id="latticeIframe" height="850px" width="100%" frameborder="0"/>
    <apex:includeScript value="{!$Resource.latticeforleads__Jquery191}"/>
    <script src="/soap/ajax/24.0/connection.js" type="text/javascript"></script>
    <script language="javascript" runat="server">
    $(document).ready(function() {
    
        // Takes in the 15 digit case sensitive ID and returns the 18 digit case insensitive version
        // Original algorithm found at http://www.adminbooster.com/tool/15to18
        function convertSalesforceId(id) {
            if(id != null && id.length == 15) {
                var modifier = "";
                
                for(var i=0;i<3; i++){
                    var f=0;
                    for(var j=0;j<5;j++){
                        var c=id.charAt(i*5+j);
                        if(c>="A" && c<="Z")f+=1<<j;
                    }
                    modifier+="ABCDEFGHIJKLMNOPQRSTUVWXYZ012345".charAt(f);
                }
                id += modifier;
            }
            return id;
        }
        
        
        var opportunityId  = "{!opportunity.id}";
        var baseLatticeUrl = "{!latticeUrl}";
        var latticeUrl = baseLatticeUrl + "?sin={!$Api.Session_ID}";
        latticeUrl += "&serverurl={!$Api.Partner_Server_URL_90}";
        latticeUrl += "&Directory=salesforce&userlink={!$User.Id}";
        latticeUrl += "&Opportunity=" + opportunityId;
        latticeUrl += "&HasSalesprism={!isSalesprismInstalled}";
        latticeUrl += "&CustomSettings=" + encodeURIComponent('{!customSettings}');

        /*
        var accountId = null;
        sforce.connection.sessionId = "{!$Api.Session_ID}";
        try {
            var query = sforce.connection.query("SELECT id,latticeforleads__AccountID__c FROM Lead where id='"+ leadId +"'");
            var records = query.getArray("records");
            if (query.size == 1 && records != null) {
                accountId = convertSalesforceId(records[0].latticeforleads__AccountID__c);
            }
        } catch (err) {}
        
        if (accountId != null) {
            latticeUrl += "&Account=" + accountId;
        }
        */
        
        function getAccountLinkField (accountId) {
            var accountDfd = $.Deferred();
            var accountField = "{!accountLinkField}";
            accountDfd.resolve(accountField);
            return accountDfd.promise();
        }
        
        // Listen for when our Dante sends postMessage events
        window.addEventListener('message', function (evt) {
            if (evt && evt.data.indexOf("IsLeadActiveEvent") !== -1) {
                var separatorIndex = evt.data.indexOf("=");
                var leadId = evt.data.substring(separatorIndex + 1, evt.data.length);
                var message = "IsLeadActiveReturnEvent=" + leadId + "?isActive=" + true;
                evt.source.postMessage(message , evt.origin);
            } else if (evt && evt.data.indexOf("GoToSalesprismAccountEvent") !== -1) {
                var separatorIndex = evt.data.indexOf("=");
                var accountId = evt.data.substring(separatorIndex + 1, evt.data.length);
                            
                var salesforceHost = window.location.host;
                var latticeForLeadsPrefix = salesforceHost.indexOf("latticeforleads.");
                if (latticeForLeadsPrefix !== -1) {
                    salesforceHost = salesforceHost.substring(16, salesforceHost.length);
                }
                
                var accountDfd = getAccountLinkField(accountId);
                $.when(accountDfd).then(function (result) {
                    var accountField = result;
                    var salesprismUrl = window.location.protocol + "//salesprism." + salesforceHost +
                        "/apex/salesPRISM?sfdc.tabName=salesPRISM&Account=" + accountField;
                    window.open(salesprismUrl, "_blank");
                });
            }
            
        }, false);
        
        $("#latticeIframe").attr('src', latticeUrl);
    });
    </script>
</apex:page>